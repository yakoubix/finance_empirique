---
title: "Gestion de Portefeuille"
subtitle: "TP-2: Droite de Marchés des Capitaux"
author: Patrick Hénaff
date: "Février-Mars 2021"
output: 
  pdf_document:
    keep_tex: true
    fig_caption: yes
    latex_engine: pdflatex
geometry: margin=1in

header-includes:
  - \usepackage[utf8]{inputenc}

bibliography: ../library.bib
csl: ../apa.csl
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

```{r load-libraries, include=FALSE, echo=TRUE}
library(quantmod)
library(xts)
library(hornpa)
library(lubridate)
library(xtable)
library(PerformanceAnalytics)
library(TTR)
library(SuppDists)
library(lubridate)
library(roll)
library(Hmisc)
library(nFactors)
library(kableExtra)

get.src.folder <- function() {
  path.expand("../GP/src")
}

get.data.folder <- function() {
  path.expand("../GP/data")
}

source(file.path(get.src.folder(), 'utils.R'))
source(file.path(get.src.folder(), 'FileUtils.R'))
```

# Données

## Séries de rendement quatidien pour 11 valeurs:

```{r, eval=TRUE, echo=TRUE, warning=FALSE}
daily.ret.file <- file.path(get.data.folder(), "daily.ret.rda")
load(daily.ret.file)
kable(table.Stats(daily.ret), "latex", booktabs=T) %>% kable_styling(latex_options="scale_down")
```

## Rendement annuel moyen:

```{r, echo=TRUE}
kable(252*100*colMeans(daily.ret), "latex", booktabs=T, digits=1, col.names=c("Rendement (%)"), 
      caption="Rendement annuel moyen")
```

## Matrice de corrélation des rendements:

```{r, echo=TRUE}
correl <- cor(daily.ret)
correl[lower.tri(correl)] <- NA
options(knitr.kable.NA = '')
kable(correl, "latex", booktabs=T, digits=2, caption="Corrélation des rendements quotidiens") %>%
kable_styling(latex_options="scale_down")
```


# Droite de Marché des Capitaux (Capital Market Line)

+ A partir des calculs présentés en cours, mettre en oeuvre une méthode numérique
  pour déterminer le portefeuille tangent quand les poids des actifs risqués sont contraints à être positifs: $w_i >= 0$.

+ Même calcul en ajoutant des contraintes supplémentaires qui vous semblent pertinentes 
(ex: pas plus de 20\% de l'actif risqué alloué à un seul titre, etc.)


## Question 1 


```{r, echo=TRUE}
rate = 0.03
assets <- colnames(daily.ret)
moy = colMeans(daily.ret)
sigma = colStdevs(daily.ret)
moments = rbind(moy, sigma)
moments[1,] = moments[1,]*252
moments[2,] = moments[2,]*sqrt(252)
rho.1 = cor(daily.ret)
colnames(moments) <- assets
mean.1 = matrix(moments[1,],11,1)
sigma.1 = matrix(moments[2,],11,1)
sigma.2 = sigma.1 %*% t(sigma.1) * rho.1
alpha <- seq(from=-0.4, to=1.4, by=0.1)
w_1 <- matrix(rep(1/11,11),11,1)
w_2 <- 1 - w_1
w <- w_1 %*% alpha + w_2 %*% (1-alpha)
mean.1.frontier = as.vector(t(mean.1) %*% w)
sigma.1.frontier = sqrt(diag(t(w) %*% sigma.2 %*% w))



w.nomi <- solve(sigma.2, mean.1-rate)
w.denomi <- sum(w.nomi)
w.t <- w.nomi/sum(w.nomi)

cex.val = 1.5
mean.t <- as.vector(t(mean.1) %*% w.t)
sigma.1.t <- sqrt(t(w.t) %*% sigma.2 %*% w.t)

```


``````{r, fig-4, warning=FALSE, echo=FALSE, fig.width=20, fig.cap="frontieres"}
plot(sigma.1.frontier, mean.1.frontier, type="b", pch=1, cex = .7,
     ylim=c(0, max(mean.1.frontier)), xlim=c(0, max(sigma.1.frontier)),
     xlab=expression(sigma.1), ylab=expression(mean.1), cex.lab = cex.val, bty='n')
text(x=0.0, y=rate, labels=expression(r[f]), pos=2, offset=0)
text(x=sigma.1, y=mean.1, labels=assets, pos=4, cex = 1)
text(x=sigma.1.t, y=mean.t, labels="Tangency", pos=2, offset=2)
abline(a=rate, b=(mean.t-rate)/sigma.1.t, col='red', lty=2)


```



## Ajout d'un actif sans risque
```{r, echo=FALSE}

min.ret = 0.05
mu.star <- seq(from=min.ret+abs(min(mean.1))/100, to=max(mean.1)-abs(max(mean.1))/100, length.out=200)
mu.free <- 0.03
tickers = assets
sol <- NULL
for(mu.s in mu.star) {
A.sum <- matrix(rep(1,11, ncol=1))
A.mat <- cbind(A.sum, mean.1, diag(11))
b <- c(1, mu.s, rep(0, 11))
qp <- solve.QP(2*sigma.2, rep(0,11), A.mat, b, meq=2)
sharpe <- (mu.s - mu.free) / sqrt(qp$value)
  tmp <- matrix(c(mu.s, sqrt(qp$value), sharpe, qp$solution), nrow=1)

if(is.null(sol)) {
  sol <- tmp  
} else {
  sol <- rbind(sol, tmp)
}
}
colnames(sol) <- c("mu", "stdev", "Sharpe", tickers)

```

```{r, echo=FALSE, fig.height=6}
plot(sol[,"stdev"], sol[,"mu"], type='l', col='red', lwd=2, xlab=expression(sigma), ylab=expression(mu),
     ylim=c(0, 0.40), xlim=c(.0, 0.40), cex.lab=1.5, bty='n')

for(i in seq_along(tickers)) {
  text(sqrt(sigma.2[i,i]), mean.1[i], tickers[i], cex=1.2, col="blue")
}
```

```{r, tangent-long}

mu.star.v  <- seq(from=mu.free, to=0.3, length.out=30)
n <- length(mean.1)
optim.with.rf <- function(mu.star) {
A.sum <- matrix(mean.1-mu.free, ncol=1)
A.mat <- cbind(A.sum,
               diag(n),-diag(n))
b <- c(mu.star-rate, rep(0, n),rep(-0.37,n))
solve.QP(2*sigma.2, rep(0,n), A.mat, b, meq=1)
}
i = 0
sol.with.rf1 <- NULL
for(mu.star in mu.star.v) {
  qp <- optim.with.rf(mu.star)
  sharpe <- (mu.star - mu.free) / sqrt(qp$value)
  tmp <- matrix(c(mu.star, sqrt(qp$value), sharpe, qp$solution), nrow=1)

if(is.null(sol.with.rf1)) {
  sol.with.rf1 <- tmp
} else {
  sol.with.rf1 <- rbind(sol.with.rf1, tmp)
}
}


tickers = assets
w.tangent <- matrix(qp$solution / sum(qp$solution), ncol=1)
names(w.tangent) <- tickers
sigma.tangent <- sqrt(t(w.tangent) %*% sigma.2 %*% w.tangent)
colnames(sol.with.rf1) <- c("mu", "stdev", "Sharpe", tickers)
```

``````{r, fig-4, warning=FALSE, echo=FALSE, fig.width=20, fig.cap="frontieres"}
plot(sol[,"stdev"], sol[,"mu"], type='l', col='red', lwd=2, xlab=expression(sigma), ylab=expression(mean),
     ylim=c(0, 0.3), xlim=c(.0, 0.3), bty='n', cex.lab=1.5)
lines(sol.with.rf1[,"stdev"], sol.with.rf1[,"mu"], type='l', col='green', lwd=2)
for(i in seq_along(tickers)) {
  text(sqrt(sigma.2[i,i]), mean.1[i], tickers[i], cex=1.2, col="blue")
}
```
